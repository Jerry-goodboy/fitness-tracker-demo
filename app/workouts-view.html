<link rel="import" href="app-theme.html" />
<dom-module id="workouts-view">
    <template>
        <style include="app-theme"></style>
        <style>
            :host {
                display: block;
                height: 100%;
            }
            vaadin-grid {
                color: #00bfa5;
                font-weight: 500;
            }
            vaadin-grid ::content thead.vaadin-grid-header {
                box-shadow: none;
            }
            vaadin-grid ::content tr td {
                border-bottom: none !important;
            }
            vaadin-grid ::content tr:hover td {
                background: #d6eaea !important;
            }
            vaadin-grid ::content tr.vaadin-grid-row td {
                background: #eff8f8;
            }
            vaadin-grid ::content tr.vaadin-grid-row-stripe td {
                background: #fff;
            }
            vaadin-grid ::content th {
                color: #004d40;
            }
            vaadin-grid ::content th.last-frozen,
            vaadin-grid ::content td.last-frozen {
                border: none !important;
            }
            vaadin-grid ::content .toggle-details {
                cursor: pointer;
                background: url(resources/vaadin-icons/arrow-circle-down-o-edit.svg) center center no-repeat;
                width: 48px;
                height: 48px;
                background-size: 18px 18px;
                position: absolute;
                top: 0;
                left: 0;
            }
            vaadin-grid ::content .toggle-details.open {
                transform: rotate(180deg);
            }
            vaadin-grid ::content .vaadin-grid-row:after {
                background: transparent;
            }

            vaadin-grid ::content .workout-details {
                width: 100vw;
                padding: 16px;
                box-sizing: border-box;
                @apply(--layout-vertical);
                background: transparent;
                color: var(--text-primary-color);
            }
            vaadin-grid ::content .workout-details .map-and-weather {
                @apply(--layout-horizontal);
            }
            vaadin-grid ::content .workout-details .map-and-weather > div {
                @apply(--layout-flex);
            }
            vaadin-grid ::content .workout-details .map-and-weather .map {
                height: 200px;
                @apply(--layout-flex-2);
            }
            vaadin-grid ::content .workout-details .map-and-weather .weather {
                display: -webkit-box;
                display: -webkit-flex;
                display: -ms-flexbox;
                display: flex;
                -webkit-box-orient: vertical;
                -webkit-box-direction: normal;
                -webkit-flex-direction: column;
                -ms-flex-direction: column;
                flex-direction: column;
                -webkit-box-pack: justify;
                -webkit-justify-content: space-between;
                -ms-flex-pack: justify;
                justify-content: space-between;
            }
            vaadin-grid ::content .workout-details .row {
                @apply(--layout-horizontal);
            }
            vaadin-grid ::content .workout-details .cell {
                padding: 20px 0 0 10px;
                @apply(--layout-flex);
            }
            vaadin-grid ::content .workout-details .cell strong {
                font-weight: 100;
                display: block;
            }
            vaadin-grid ::content .workout-details iron-icon {
                float: left;
                margin-right: 8px;
            }

            app-toolbar #back-button {
                background: var(--secondary-color);
                padding: 5px;
                border-radius: 4px;
                display: inline-block;
                cursor: pointer;
            }
        </style>

        <div class="layout vertical" style="min-height: 100%">
            <app-toolbar user="[[user]]">
                <span class="h1">Workout details</span>
                <div class="h2" id="back-button" on-tap="_navigateBack">Back to summary</div>
            </app-toolbar>
            <vaadin-grid class="flex" frozen-columns="1" selection-mode="disabled" id="workoutGrid">
                <table>
                    <colgroup>
                        <col width="20" />
                        <col name="date" header-text="DATE" sortable />
                        <col name="distance" header-text="DISTANCE" sortable />
                        <col name="duration" header-text="TIME" sortable />
                        <col name="calories" header-text="CALORIES" sortable />
                        <col name="avgPace" header-text="AVG PACE" sortable />
                    </colgroup>
                </table>
            </vaadin-grid>
        </div>
        <div style="display: none" id="templateWrapper">
            <template is="dom-bind" id="workoutDetails">
                <div class="workout-details">
                    <div class="map-and-weather">
                        <div class="map">
                            <google-map id="routeMap" latitude="60.42610282861618" longitude="22.152894500000002"></google-map>
                        </div>
                        <div class="weather">
                            <div class="cell"><iron-icon class="big" src="resources/weather-icons/temperature.png"></iron-icon><strong>Temp</strong>[[formatTemperature(workout.temperature)]]</div>
                            <div class="cell"><iron-icon class="big" src="resources/weather-icons/Wet.png"></iron-icon><strong>Humidity</strong><span>[[workout.humidity]]</span>%</div>
                            <div class="cell"><iron-icon class="big" src$="[[_getWeatherIcon(workout.weather)]]"></iron-icon><strong>Weather</strong>[[workout.weather]]</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="cell"><strong>Calories</strong><span>[[workout.calories]]</span> kcal</div>
                        <div class="cell"><strong>Avg pace</strong><span>[[formatDuration(workout.avgPace)]]</span> min/km</div>
                        <div class="cell"><strong>Max pace</strong><span>[[formatDuration(workout.maxPace)]]</span> min/km</div>
                    </div>
                    <div class="row">
                        <div class="cell"><strong>Min altitude</strong><span>[[workout.minAlt]]</span> m</div>
                        <div class="cell"><strong>Max altitude</strong><span>[[workout.maxAlt]]</span> m</div>
                        <div class="cell"><strong>Ascent/descent</strong><span>[[formatAscent(workout.ascent)]]</span> m</div>
                    </div>
                    <div style="height: 250px; margin-top: 20px;">
                        <speed-altitude-chart
                            speed-data$="[[workout.speedData.speed]]"
                            altitude-data$="[[workout.speedData.altitude]]"
                            labels$="[[workout.speedData.labels]]">
                        </speed-altitude-chart>
                    </div>
                </div>
            </template>
        </div>
    </template>

    <script>
        Polymer({
            is: 'workouts-view',
            behaviors: [
                Polymer.NeonAnimatableBehavior
            ],
            properties: {
                animationConfig: {
                    value: function() {
                        return {
                            'entry': {
                                name: 'slide-from-right-animation',
                                node: this
                            },
                            'exit': {
                                name: 'slide-right-animation',
                                node: this
                            }
                        };
                    }
                },
                user: Object,
                weekData: {
                    type: Object,
                    observer: '_weekDataChanged'
                }
            },

            _navigateBack: function() {
                this.fire('navigate', 'summary');
            },

            pageTransitionFinished: function() {
                // Workaround for vaadin-grid issue #172
                // https://github.com/vaadin/vaadin-grid/issues/172
                var grid = this.$.workoutGrid;
                grid.data.source = grid.data.source;
            },

            ready: function() {
                var template = this.$.workoutDetails;
                template.formatDuration = Formatters.duration;
                template.formatAscent = function(ascent) {
                    return (ascent > 0 ? '+' + ascent : ascent);
                }
                template.formatTemperature = function(temperature) {
                    return (temperature > 0 ? '+' + temperature : temperature) + ' C';
                }

                var visibleRowDetails = [];
                var grid = this.$.workoutGrid;
                var self = this;
                var renderers = {
                    date: function(cell) {
                        cell.element.innerHTML = Formatters.date(cell.data);
                    },
                    distance: function(cell) {
                        cell.element.innerHTML = Formatters.distance(cell.data);
                    },
                    duration: function(cell) {
                        cell.element.innerHTML = Formatters.duration(cell.data, true);
                    },
                    calories: function(cell) {
                        cell.element.innerHTML = cell.data + ' kcal';
                    },
                    pace: function(cell) {
                        cell.element.innerHTML = Formatters.duration(cell.data) + ' min/km';
                    },
                    toggle: function(cell) {
                        var toggle = document.createElement('div');
                        toggle.classList.add('toggle-details');
                        var rowIndex = cell.row.index;
                        toggle.addEventListener('click', function(e) {
                            if (visibleRowDetails.indexOf(rowIndex) === -1) {
                                visibleRowDetails.push(rowIndex);
                                grid.setRowDetailsVisible(rowIndex, true);
                            } else {
                                visibleRowDetails.splice(visibleRowDetails.indexOf(rowIndex), 1);
                                grid.setRowDetailsVisible(rowIndex, false);
                            }
                        });
                        (visibleRowDetails.indexOf(rowIndex) === -1 ? toggle.classList.remove('open') : toggle.classList.add('open'));
                        if (cell.element.firstChild) {
                            cell.element.removeChild(cell.element.firstChild);
                        }
                        cell.element.appendChild(toggle);
                    }
                }
                grid.columns[0].renderer = renderers.toggle;
                grid.columns[1].renderer = renderers.date;
                grid.columns[2].renderer = renderers.distance;
                grid.columns[3].renderer = renderers.duration;
                grid.columns[4].renderer = renderers.calories;
                grid.columns[5].renderer = renderers.pace;

                grid.rowDetailsGenerator = function(rowIndex) {
                    var details = document.createElement('div');
                    details.classList.add('workout-details');
                    grid.data.getItem(rowIndex, function(err, item) {
                        if (!err) {
                            var detailsTemplate = self.$.workoutDetails;
                            detailsTemplate._getWeatherIcon = function(weather) {
                                switch (weather) {
                                    case 'Dry':
                                        return 'resources/weather-icons/Sun.png';
                                    case 'Rain':
                                        return 'resources/weather-icons/Rain.png';
                                    default:
                                        return 'resources/weather-icons/Clouds.png';
                                }
                            };
                            detailsTemplate.workout = item;
                            details.innerHTML = self.$.templateWrapper.querySelector('.workout-details').innerHTML;

                            details.addEventListener('google-map-ready', function() {
                                // Sample data – Teemu's Ruisrääkki from 2014.
                                this.querySelector('#routeMap').kml = 'https://dl.dropboxusercontent.com/u/2502415/vaadin/fitness/activity_594778529.kml';
                            });
                        }
                    });
                    return details;
                };
            },

            _weekDataChanged: function() {
                this.$.workoutGrid.data.source = this.weekData.workouts;
            }
        });
    </script>
</dom-module>
