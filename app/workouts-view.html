<link rel="import" href="app-theme.html" />
<dom-module id="workouts-view">
    <template>
        <style include="app-theme"></style>
        <style>
            :host {
                display: block;
                height: 100%;
            }
            vaadin-grid {
                color: #00bfa5;
                font-weight: 500;
            }
            vaadin-grid ::content thead {
                box-shadow: none;
            }
            vaadin-grid ::content tr td {
                border-bottom: none !important;
            }
            vaadin-grid ::content tr:hover td {
                background: #d6eaea !important;
            }
            vaadin-grid ::content tr.vaadin-grid-row td {
                background: #eff8f8;
            }
            vaadin-grid ::content tr.vaadin-grid-row-stripe td {
                background: #fff;
            }
            vaadin-grid ::content th {
                color: #004d40;
            }
            vaadin-grid ::content th.last-frozen,
            vaadin-grid ::content td.last-frozen {
                border: none !important;
            }
            vaadin-grid ::content .toggle-details {
                cursor: pointer;
            }
            vaadin-grid ::content .vaadin-grid-row:after {
                background: transparent;
            }

            vaadin-grid ::content .workout-details {
                width: 100vw;
                padding: 16px;
                box-sizing: border-box;
                display: -webkit-box;
                display: -webkit-flex;
                display: -ms-flexbox;
                display: flex;
                -webkit-box-orient: vertical;
                -webkit-box-direction: normal;
                -webkit-flex-direction: column;
                -ms-flex-direction: column;
                flex-direction: column;
                background: transparent;
                color: var(--text-primary-color);
            }
            vaadin-grid ::content .workout-details .map-and-weather {
                display: -webkit-box;
                display: -webkit-flex;
                display: -ms-flexbox;
                display: flex;
                -webkit-box-orient: horizontal;
                -webkit-box-direction: normal;
                -webkit-flex-direction: row;
                -ms-flex-direction: row;
                flex-direction: row;
            }
            vaadin-grid ::content .workout-details .map-and-weather > div {
                -webkit-box-flex: 1;
                -webkit-flex: 1;
                -ms-flex: 1;
                flex: 1;
            }
            vaadin-grid ::content .workout-details .map-and-weather .map {
                height: 200px;
                -webkit-box-flex: 2;
                -webkit-flex: 2;
                -ms-flex: 2;
                flex: 2;
            }
            vaadin-grid ::content .workout-details .map-and-weather .weather {
                display: -webkit-box;
                display: -webkit-flex;
                display: -ms-flexbox;
                display: flex;
                -webkit-box-orient: vertical;
                -webkit-box-direction: normal;
                -webkit-flex-direction: column;
                -ms-flex-direction: column;
                flex-direction: column;
                -webkit-box-pack: justify;
                -webkit-justify-content: space-between;
                -ms-flex-pack: justify;
                justify-content: space-between;
            }
            vaadin-grid ::content .workout-details .row {
                display: -webkit-box;
                display: -webkit-flex;
                display: -ms-flexbox;
                display: flex;
            }
            vaadin-grid ::content .workout-details .cell {
                padding: 20px 0 0 10px;
                -webkit-box-flex: 1;
                -webkit-flex: 1;
                -ms-flex: 1;
                flex: 1;
            }
            vaadin-grid ::content .workout-details .cell strong {
                font-weight: 100;
                display: block;
            }
            vaadin-grid ::content .workout-details iron-icon {
                float: left;
                margin-right: 8px;
            }

            app-toolbar #back-button {
                background: var(--secondary-color);
                padding: 5px;
                border-radius: 4px;
                display: inline-block;
                cursor: pointer;
            }
            /*
            @media (min-width: 600px) {
                vaadin-grid ::content .workout-details {
                    -webkit-box-orient: horizontal;
                    -webkit-box-direction: normal;
                    -webkit-flex-direction: row;
                    -ms-flex-direction: row;
                    flex-direction: row;
                    -webkit-box-pack: justify;
                    -webkit-justify-content: space-between;
                    -ms-flex-pack: justify;
                    justify-content: space-between;
                }
                vaadin-grid ::content .workout-details .row {
                    -webkit-box-orient: vertical;
                    -webkit-box-direction: normal;
                    -webkit-flex-direction: column;
                    -ms-flex-direction: column;
                    flex-direction: column;
                }
                vaadin-grid ::content .workout-details .map-and-weather {
                    -webkit-box-flex: 2;
                    -webkit-flex: 2;
                    -ms-flex: 2;
                    flex: 2;
                }
            }*/
        </style>

        <div class="layout vertical" style="min-height: 100%">
            <app-toolbar>
                <span class="h1">Workout details</span>
                <div class="h2" id="back-button" on-tap="_navigateBack">Back to summary</div>
            </app-toolbar>
            <vaadin-grid class="flex" frozen-columns="1" selection-mode="disabled" id="workoutGrid">
                <table>
                    <colgroup>
                        <col width="20" />
                        <col name="date" header-text="DATE" sortable />
                        <col name="distance" header-text="DISTANCE" sortable />
                        <col name="duration" header-text="TIME" sortable />
                        <col name="calories" header-text="CALORIES" sortable />
                        <col name="avgPace" header-text="AVG PACE" sortable />
                    </colgroup>
                </table>
            </vaadin-grid>
        </div>
        <div style="display: none" id="templateWrapper">
            <template is="dom-bind" id="workoutDetails">
                <div class="workout-details">
                    <div class="map-and-weather">
                        <div class="map">
                            <google-map id="routeMap"></google-map>
                        </div>
                        <div class="weather">
                            <div class="cell"><iron-icon class="big" src="resources/weather-icons/temperature.png"></iron-icon><strong>Temp</strong>{{formatTemperature(workout.temperature)}}</div>
                            <div class="cell"><iron-icon class="big" src="resources/weather-icons/Wet.png"></iron-icon><strong>Humidity</strong><span>{{workout.humidity}}</span>%</div>
                            <div class="cell"><iron-icon class="big" src="resources/weather-icons/Sun.png"></iron-icon><strong>Weather</strong>{{workout.weather}}</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="cell"><strong>Calories</strong><span>{{workout.calories}}</span> kcal</div>
                        <div class="cell"><strong>Avg pace</strong><span>{{formatDuration(workout.avgPace)}}</span> min/km</div>
                        <div class="cell"><strong>Max pace</strong><span>{{formatDuration(workout.maxPace)}}</span> min/km</div>
                    </div>
                    <div class="row">
                        <div class="cell"><strong>Min altitude</strong><span>{{workout.minAlt}}</span> m</div>
                        <div class="cell"><strong>Max altitude</strong><span>{{workout.maxAlt}}</span> m</div>
                        <div class="cell"><strong>Ascent/descent</strong><span>{{formatAscent(workout.ascent)}}</span> m</div>
                    </div>
                    <div style="height: 250px; margin-top: 20px;">
                        <speed-altitude-chart
                            speed-data="[8, 9, 8, 8, 10, 11, 12]"
                            altitude-data="[100, 103, 104, 113, 103, 92, 81]"
                            labels='["0 km", "2 km", "4 km", "6 km", "8 km", "10 km", "12 km"]'>
                        </speed-altitude-chart>
                    </div>
                </div>
            </template>
        </div>
    </template>

    <script>
        Polymer({
            is: 'workouts-view',
            behaviors: [
                Polymer.NeonAnimatableBehavior
            ],
            properties: {
                animationConfig: {
                    value: function() {
                        return {
                            'entry': {
                                name: 'slide-from-right-animation',
                                node: this
                            },
                            'exit': {
                                name: 'slide-right-animation',
                                node: this
                            }
                        };
                    }
                },
                workouts: {
                    type: Array,
                    value: [
                        {
                            "date": "2015-09-08T08:25:43.511Z",
                            "distance": 1505,
                            "duration": 5743,
                            "weather": "Dry",
                            "humidity": 5,
                            "temperature": 19,
                            "calories": 1616,
                            "avgPace": 397,
                            "maxPace": 280,
                            "minAlt": 113,
                            "maxAlt": 132,
                            "ascent": 19
                        },
                        {
                            "date": "2015-09-05T18:25:43.511Z",
                            "distance": 1005,
                            "duration": 3043,
                            "weather": "Dry",
                            "humidity": 5,
                            "temperature": 22,
                            "calories": 1516,
                            "avgPace": 397,
                            "maxPace": 280,
                            "minAlt": 103,
                            "maxAlt": 122,
                            "ascent": 19
                        },
                        {
                            "date": "2015-09-03T18:25:43.511Z",
                            "distance": 500,
                            "duration": 62,
                            "weather": "Dry",
                            "humidity": 5,
                            "temperature": 16,
                            "calories": 1516,
                            "avgPace": 397,
                            "maxPace": 280,
                            "minAlt": 103,
                            "maxAlt": 122,
                            "ascent": -19
                        }
                    ]
                }
            },

            _navigateBack: function() {
                this.fire('navigate', 'summary');
            },

            ready: function() {
                var template = this.$.workoutDetails;
                template.formatDuration = this._formatDuration;
                template.formatAscent = function(ascent) {
                    return (ascent > 0 ? '+' + ascent : ascent);
                }
                template.formatTemperature = function(temperature) {
                    return (temperature > 0 ? '+' + temperature : temperature) + ' C';
                }

                var visibleRowDetails = [];
                var grid = this.$.workoutGrid;
                var self = this;
                var renderers = {
                    date: function(cell) {
                        cell.element.innerHTML = moment(cell.data).fromNow().toUpperCase();
                    },
                    distance: function(cell) {
                        if (cell.data >= 1000) {
                            cell.element.innerHTML = (cell.data / 1000).toFixed(2) + ' km';
                        } else {
                            cell.element.innerHTML = cell.data + ' m';
                        }
                    },
                    duration: function(cell) {
                        cell.element.innerHTML = self._formatDuration(cell.data, true);
                    },
                    calories: function(cell) {
                        cell.element.innerHTML = cell.data + ' kcal';
                    },
                    pace: function(cell) {
                        cell.element.innerHTML = self._formatDuration(cell.data) + ' min/km';
                    },
                    toggle: function(cell) {
                        var toggle = document.createElement('div');
                        toggle.classList.add('toggle-details');
                        var rowIndex = cell.row.index;
                        toggle.addEventListener('click', function(e) {
                            if (visibleRowDetails.indexOf(rowIndex) === -1) {
                                visibleRowDetails.push(rowIndex);
                                grid.setRowDetailsVisible(rowIndex, true);
                            } else {
                                visibleRowDetails.splice(visibleRowDetails.indexOf(rowIndex), 1);
                                grid.setRowDetailsVisible(rowIndex, false);
                            }
                        });
                        toggle.innerHTML = (visibleRowDetails.indexOf(rowIndex) === -1 ? '&#9654;' : '&#9660;');
                        if (cell.element.firstChild) {
                            cell.element.removeChild(cell.element.firstChild);
                        }
                        cell.element.appendChild(toggle);
                    }
                }
                grid.columns[0].renderer = renderers.toggle;
                grid.columns[1].renderer = renderers.date;
                grid.columns[2].renderer = renderers.distance;
                grid.columns[3].renderer = renderers.duration;
                grid.columns[4].renderer = renderers.calories;
                grid.columns[5].renderer = renderers.pace;
                grid.data.source = this.workouts;

                grid.rowDetailsGenerator = function(rowIndex) {
                    var details = document.createElement('div');
                    details.classList.add('workout-details');
                    grid.data.getItem(rowIndex, function(err, item) {
                        if (!err) {
                            var detailsTemplate = self.$.workoutDetails;
                            detailsTemplate.workout = item;
                            details.innerHTML = self.$.templateWrapper.querySelector('.workout-details').innerHTML;

                            details.addEventListener('google-map-ready', function() {
                                // Test data – Teemu's Ruisrääkki from 2014.
                                this.querySelector('#routeMap').kml = 'https://dl.dropboxusercontent.com/u/2502415/vaadin/fitness/activity_594778529.kml';
                            });
                        }
                    });
                    return details;
                };
            },

            _getWorkoutDetailsHtml: function(workout) {
                var detailsTemplate = document.getElementById('workout-details');
                detailsTemplate.workout = workout;
                return this.$.templateWrapper.querySelector('.workout-details').innerHTML;
            },

            _formatDuration: function(seconds, displayHours) {
                if (arguments.length === 1) {
                    displayHours = false;
                }
                var duration = moment.duration(seconds, 'seconds')
                var format = '';
                if (displayHours) {
                    format += duration.hours() + ':';
                }
                format += (duration.minutes() < 10 ? '0' + duration.minutes() : duration.minutes());
                format += ':' + (duration.seconds() < 10 ? '0' + duration.seconds() : duration.seconds());
                return format;
            }
        });
    </script>
</dom-module>
